---
title: "ä¸€ä¸ªå¤©çœŸçš„ä½ä»·ä¹°å…¥ç­–ç•¥"
author: "é‚±é£"
date: "ä¸‡é‡Œå­¦é™¢"
output:
  revealjs::revealjs_presentation:
    theme: sky
    reveal_options:
      slideNumber: true
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
load("stock_clean.rda")
```

## æ‰¾å‡ºä½ä»·è‚¡çš„æ­¥éª¤ ##

* å…ˆè®¡ç®—å‡ºæ¯åªè‚¡ç¥¨æœ€æ–°æ”¶ç›˜ä»·ä¸å…¶å‰30ä¸ªäº¤æ˜“æ—¥çš„æ”¶ç›˜ä»·ä¸­ä½æ•°ä¹‹æ¯”under_ratioï¼Œ

* ç„¶åæŒ‰ç…§under_ratioçš„å€¼å¯¹è‚¡ç¥¨è¿›è¡Œå‡åºæ’åºï¼Œ

* ç„¶åä»ä¸­é€‰å‡ºæ’åœ¨æœ€å‰é¢çš„10åªè‚¡ç¥¨ã€‚

è¿™10åªè‚¡ç¥¨æˆ‘ä»¬è®¤ä¸ºä»·æ ¼è¾ƒä½ã€‚

## è·å¾—æ¯ä¸ªè‚¡ç¥¨æœ€è¿‘ä¸‰åä¸ªäº¤æ˜“æ—¥çš„æ•°æ®

* å› ä¸ºæ‰€æœ‰è‚¡ç¥¨åœ¨ä¸€ä¸ªæ•°æ®é›†é‡Œï¼Œæ‰€ä»¥æˆ‘ä»¬ä¾ç„¶éœ€è¦å¯¹åŸå§‹æ•°æ®è¿›è¡Œåˆ†ç»„

* ä½†æˆ‘ä»¬çš„`stock_clean`æ•°æ®é›†å·²ç»æŒ‰`code`å˜é‡åˆ†è¿‡ç»„äº†ï¼Œæ‰€ä»¥ä¸éœ€å†åšåˆ†ç»„æ“ä½œã€‚

* `slice`å‡½æ•°æ¥è‡ª`ldpyr`å®åŒ…

```{r get the latest N day data}

library(dplyr)
number_of_days = 30
stock_latest = slice(stock_clean,1:number_of_days)

```

## ä¸€ä¸ªå°å°çš„æ•°æ®æ¸…æ´—è¿‡ç¨‹

* google finance ä¸­ä¸æ˜¯æ‰€æœ‰è‚¡ç¥¨æ•°æ®éƒ½åœ¨åŒæ­¥æ›´æ–°

* æ‰€ä»¥æˆ‘ä»¬è¦å»æ‰è¿‘30å¤©æ²¡æœ‰æ•°æ®çš„è‚¡ç¥¨

* stock_cleanæ•°æ®é›†ä¸­æœ€æ–°æ—¥æœŸä¸º2017å¹´1æœˆ18æ—¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å»æ‰æ—¥æœŸåœ¨2016å¹´12æœˆä»¥å‰çš„æ•°æ®ï¼Œå¤§è‡´å¯ä»¥ä¿è¯ç•™ä¸‹çš„éƒ½æ˜¯è¿‘30å¤©æœ‰æ•°æ®æ›´æ–°çš„è‚¡ç¥¨ã€‚

## å»æ‰æ²¡æœ‰å³æ—¶æ›´æ–°çš„è‚¡ç¥¨

```{r new data}

stock_latest_clean = filter(stock_latest,date >= "2016-12-01")


```


## è·å¾—æ¯åªè‚¡ç¥¨å½“å‰åŒºé—´çš„æ”¶ç›˜ä»·æ ¼ä¸­ä½æ•°


* latest_date è®°å½•çš„æ˜¯è‚¡ç¥¨äº¤æ˜“çš„æœ€åä¸€å¤©çš„æ—¶é—´
* è‚¡ç¥¨æ•°æ®æ˜¯æŒ‰ç…§æ—¶é—´é™åºæ’åˆ—çš„ï¼Œä¹Ÿå°±è¯´æ—¥æœŸè¶Šæ™šçš„æ•°æ®æ’åœ¨è¶Šå‰é¢
*  firstå‡½æ•°æ˜¯è·å–æ’åœ¨ç¬¬ä¸€ä½çš„æ•°æ®

```{r}

latest_median = summarise(stock_latest_clean,
                        latest_date = first(date),
                        median_close = median(close)
                        )
```

## è·å¾—æ¯åªè‚¡ç¥¨å½“å‰åŒºé—´çš„æœ€æ–°æ”¶ç›˜ä»·æ ¼


```{r}

latest_close = summarise(stock_latest_clean,
                          latest_date = first(date),
                          latest_close = first(close))

```

## mergeå†å²ä¸­ä½æ•°å’Œæœ€æ–°ä»·æ ¼ ##

* ä¿å­˜å†å²ä¸­ä½æ•°çš„æ•°æ®é›†latest_median
* ä¿å­˜æœ€æ–°ä»·æ ¼çš„æ•°æ®é›†latest_close


```{r}
# merge å‡½æ•°æœ‰ä¸‰ä¸ªå‚æ•°
# ç¬¬ä¸€å’Œç¬¬äºŒä¸ªæ˜¯è¦åˆå¹¶çš„æ•°æ®é›†çš„åå­—
# ç¬¬ä¸‰ä¸ªæ˜¯å¯¹æ•°æ®é›†è¿›è¡Œåˆå¹¶çš„æ ‡ç¤ºå˜é‡ï¼Œå¯ä»¥ç†è§£ä¸ºå°†ä»€ä¹ˆå˜é‡ä½œä¸ºä¸åŒæ•°æ®çš„èº«ä»½è¯
median_close = merge(latest_median,latest_close,
                     by = c("code","latest_date")) 

```

## ä¸ºä»€ä¹ˆè¦åˆå¹¶è¿™ä¸¤ä¸ªæ•°æ®é›† ##

* å½“éœ€è¦å¯¹ä¸¤ä¸ªç›¸å…³çš„å˜é‡è¿›è¡Œæ“ä½œçš„æ—¶ä¾¯ï¼Œæœ€å¥½æŠŠå¥¹ä»¬æ”¾åˆ°ä¸€ä¸ªå¯¹è±¡é‡Œå»ã€‚

> ä½ ä»¬ä¼šé‡è§ä¸åŒçš„äººï¼Œèµ°è¿‡ä¸åŒçš„è·¯ï¼Œä½†æ˜¯åœ¨Ræ•°æ®åˆ†æé‡Œï¼Œæœ€å¥½æŠŠç›¸å…³æ•°æ®æ”¾åˆ°åŒä¸€ä¸ªdataframeä¸­ã€‚


## è®¡ç®—ä½ä¼°ç‡æŒ‡æ ‡ ##

å®šä¹‰ä½ä¼°ç‡è®¡ç®—å…¬å¼ï¼š

> under_ratio = latest_close/median_close

```{r under value ratio}
under_close = mutate(median_close,
                     under_ratio = latest_close/median_close)
```

* median_closeæ•°æ®é›†ç°åœ¨å¤šäº†ä½ä¼°ç‡è¿™ä¸€åˆ—

* æ–°çš„æ•°æ®é›†å‘½åä¸ºunder_close

## è·å¾—æœ€è¢«ä½ä¼°çš„ååªè‚¡ç¥¨


* å¯¹under_closeæ•°æ®é›†æŒ‰ç…§ä½ä¼°ç‡å‡åºæ’åˆ—

* æ’åœ¨å‰10åçš„å°±æ˜¯æœ€è¢«ä½ä¼°çš„ååªè‚¡ç¥¨

```{r under top10}

under_close_sort = arrange(under_close,under_ratio)

# å–å‡ºunder_close_sortä¸­æ’åå‰10çš„è‚¡ç¥¨
under_close_top10 = head(under_close_sort,10) 

head(under_close_top10)

```


## ä½†æ˜¯ï¼Œä»¥ä»€ä¹ˆä»·æ ¼ä¹°å…¥å‘¢ï¼Ÿ

* æˆ‘ä»¬ç°åœ¨æ‰¾åˆ°äº†æ²ªæ·±ä¸¤å¸‚é™¤å»åˆ›ä¸šæ¿ä¹‹å¤–ï¼Œæœ€è¢«ä½ä¼°çš„ååªè‚¡ç¥¨ã€‚

> âš ï¸ æ³¨æ„ï¼šåªæ˜¯æˆ‘ä»¬å¤©çœŸçš„è®¤ä¸ºçš„æœ€è¢«ä½ä¼°çš„è‚¡ç¥¨ï¼Œä¸æ„æˆä¹°å…¥å»ºè®®ï¼ï¼ï¼
  
>  there is a **lie** even in be**lie**ve

* ä½†æ˜¯ï¼Œå¦‚æœçœŸæœ‰ä¸å·®é’±çš„åœŸè±ªè¦è´­ä¹°çš„è¯ï¼Œä½ å»ºè®®ä»–ä»¥ä»€ä¹ˆä»·æ ¼ä¹°å…¥å‘¢ï¼Ÿï¼ˆåæ­£ä¸æ˜¯æˆ‘è‡ªå·±çš„é’±ğŸ˜ï¼‰


## æˆ‘ä»¬æƒ³åˆ°äº†å‡å€¼çš„å¥½åŸºå‹

* ä¹‹å‰æˆ‘ä»¬åœ¨é€‰æ‹©ä½ä¼°çš„è‚¡ç¥¨æ—¶ç”¨åˆ°äº†ä¸­ä½æ•°

* ä¸­ä½æ•°å¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§å—æç«¯å€¼å½±å“è¾ƒå°çš„å‡å€¼

* å‡å€¼ä¸€èˆ¬å’Œä»–çš„å¥½åŸºå‹æ ‡å‡†å·®åŒæ—¶å‡ºç°

* äºæ˜¯æˆ‘ä»¬å†³å®šåœ¨ä»æ ‡å‡†å·®å‡ºå‘ï¼Œç»™å‡ºå…·ä½“çš„ä¹°å…¥å’Œå–å‡ºå»ºè®®ã€‚

## ç¡®å®šä¹°å…¥å’Œå–å‡ºä»·æ ¼

> æ”¶ç›˜ä»·æœ€è¿‘30å¤©ä¸­ä½æ•°è®°ä¸ºUï¼Œæœ€è¿‘30å¤©æ ‡å‡†å·®è®°ä¸ºD

* å¦‚æœæœ€æ–°æ”¶ç›˜ä»·ä½äºU-2Dï¼Œå°±ä¹°å…¥

* å¦‚æœæœ€æ–°æ”¶ç›˜ä»·é«˜äºU+2Dï¼Œå°±å–å‡º

## è·å–é€‰å®šçš„ååªè‚¡ç¥¨è¿‘ä¸‰åå¤©çš„æ ‡å‡†å·® ##

```{r top10 sd}
# æå–è¿™10åªè‚¡ç¥¨çš„æ•°æ®
under_top10 = filter(stock_latest_clean, 
                     code %in% under_close_top10$code) 

# è·å–è¿™ååªè‚¡ç¥¨è¿‘30å¤©çš„æ•°æ®

under_top10_30 = slice(under_top10,1:30)

# è®¡ç®—è¿™ååªè‚¡ç¥¨çš„æ ‡å‡†å·®
under_top10_sd = summarize(under_top10_30,D = sd(close))

```


## å°†æœ€æ–°æ”¶ç›˜ä»·ï¼Œä¸­ä½æ•°å’Œæ ‡å‡†å·®æ•°æ®åˆå¹¶åˆ°ä¸€ä¸ªæ•°æ®é›†å†…

* å‚¨å­˜æœ€æ–°æ”¶ç›˜ä»·å’Œä¸­ä½æ•°çš„æ•°æ®é›†æ˜¯under_close_top10

* å‚¨å­˜è¿‘30å¤©æ ‡å‡†å·®çš„æ•°æ®é›†æ˜¯under_top10_sd

```{r operation data}

operation = merge(under_close_top10,
                  under_top10_sd,
                  by = "code")



```


## ç”Ÿæˆä¹°å…¥å’Œå–å‡ºæŒ‡æ ‡

```{r operation index}

operation_index = transmute(operation,
                            code = code,
                            date = latest_date,
                            low = median_close - 2*D,
                            high = median_close + 2*D,
                            price = latest_close,
                            ratio = under_ratio)

operation_sort = arrange(operation_index,ratio)

```


## ç”Ÿæˆå®¹æ˜“é˜…è¯»çš„æŠ¥å‘Š

```{r report}

report = transmute(operation_sort,
                   code = code,
                   date = date,
                   buy_or_not = if_else(price<low,"ä¸»äººå¸¦æˆ‘å›å®¶å§!",
                                 "ä¸»å…¬è¯·ä¸‰æ€!!!"),
                   sell_or_not = if_else(price>= high,"åˆ†æ‰‹!!!",
                                  "å¾®è‡£è¿˜èƒ½æ•ˆçŠ¬é©¬ä¹‹åŠ³!"),
                   ratio = ratio)

```


## æœ€ç»ˆæŠ¥å‘Š

```{r final report,echo=FALSE}

kable(report)

```

